<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Mrhao"><title>PHP写个资源失效下载防盗链 · Mrhao Blog</title><meta name="description" content="前言疫情期间闲的没事学了PHP，显然对于总是折腾网站的我很是管用，很多时候我甚至用它写了些很奇葩的东西，什么彩票概率计算啊，给老弟发作业啊，这些都是后话，这次写个正常点的，大部分博客可能会有自己的后端或是自己站点的资源服务器文章里一些资源链接又怕被盗用（wordpress这些一站式往后稍稍），毕竟写"><meta name="keywords" content="[&quot;MrhaoBlog&quot;,&quot;Mr.hao&quot;,&quot;Windows&quot;,&quot;Linux&quot;,&quot;html&quot;,&quot;Web&quot;,&quot;Mrhao博客&quot;]"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><script src="https://www.googletagmanager.com/gtag/js?id=UA-164546111-1"></script><script>window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-164546111-1');</script><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/blog/css/style.css"><link rel="stylesheet" href="/blog/css/blog_basic.css"><link rel="stylesheet" href="/blog/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="https://q.qlogo.cn/headimg_dl?dst_uin=2859676251&amp;spec=640" style="width:127px;border-radius: 100%;"><h3 title><a href="/">Mrhao Blog</a></h3><div class="description"><p>Mrhao'Blog鸽子在校博主的技术型博客</p></div></div></div><ul class="social-links"><li><a href="http://github.com/JHPatchouli"><i class="fa fa-github"></i></a></li></ul><div class="footer"><div class="by_blog"><span>Blog by</span><a href="https://github.com/JHPatchouli"> Mrhao</a><br><span>Theme modfiy by</span><a href="https://github.com/JHPatchouli"> JHPatchouli</a><br><span>Theme by </span></div><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">本站由hexo驱动&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/blog">首页</a></li><li><a href="/blog/about">关于</a></li><li><a href="/blog/archives">归档</a></li><li><a href="/blog/links">友链</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="https://q.qlogo.cn/headimg_dl?dst_uin=2859676251&amp;spec=640"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>PHP写个资源失效下载防盗链</a></h3></div><div class="post-content"><h5 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h5><h4 id="疫情期间闲的没事学了PHP，显然对于总是折腾网站的我很是管用，很多时候我甚至用它写了些很奇葩的东西，什么彩票概率计算啊，给老弟发作业啊，这些都是后话，这次写个正常点的，大部分博客可能会有自己的后端或是自己站点的资源服务器文章里一些资源链接又怕被盗用（wordpress这些一站式往后稍稍），毕竟写着玩肯定比不过那些一站式的下载验证，只需PHP环境就行，不需要数据库下面直接上思路和下载地址，不说直接上链接和思路"><a href="#疫情期间闲的没事学了PHP，显然对于总是折腾网站的我很是管用，很多时候我甚至用它写了些很奇葩的东西，什么彩票概率计算啊，给老弟发作业啊，这些都是后话，这次写个正常点的，大部分博客可能会有自己的后端或是自己站点的资源服务器文章里一些资源链接又怕被盗用（wordpress这些一站式往后稍稍），毕竟写着玩肯定比不过那些一站式的下载验证，只需PHP环境就行，不需要数据库下面直接上思路和下载地址，不说直接上链接和思路" class="headerlink" title="疫情期间闲的没事学了PHP，显然对于总是折腾网站的我很是管用，很多时候我甚至用它写了些很奇葩的东西，什么彩票概率计算啊，给老弟发作业啊，这些都是后话，这次写个正常点的，大部分博客可能会有自己的后端或是自己站点的资源服务器文章里一些资源链接又怕被盗用（wordpress这些一站式往后稍稍），毕竟写着玩肯定比不过那些一站式的下载验证，只需PHP环境就行，不需要数据库下面直接上思路和下载地址，不说直接上链接和思路"></a>疫情期间闲的没事学了PHP，显然对于总是折腾网站的我很是管用，很多时候我甚至用它写了些很奇葩的东西，什么彩票概率计算啊，给老弟发作业啊，这些都是后话，这次写个正常点的，大部分博客可能会有自己的后端或是自己站点的资源服务器文章里一些资源链接又怕被盗用（wordpress这些一站式往后稍稍），毕竟写着玩肯定比不过那些一站式的下载验证，只需PHP环境就行，不需要数据库下面直接上思路和下载地址，不说直接上链接和思路</h4><h4 id="项目链接https-github-com-JHPatchouli-PHPDownloadCheck"><a href="#项目链接https-github-com-JHPatchouli-PHPDownloadCheck" class="headerlink" title="项目链接https://github.com/JHPatchouli/PHPDownloadCheck"></a>项目链接<a href="https://github.com/JHPatchouli/PHPDownloadCheck" target="_blank" rel="noopener">https://github.com/JHPatchouli/PHPDownloadCheck</a></h4><h5 id="涉及以下知识"><a href="#涉及以下知识" class="headerlink" title="涉及以下知识"></a>涉及以下知识</h5><blockquote>
<p>php：超文本预处理器（懂得处理json是关键）</p>
<p>json：一种轻量级的数据交换格式（用它代替了数据库）</p>
</blockquote>
<h3 id="思路-1"><a href="#思路-1" class="headerlink" title="思路    1"></a>思路    1</h3><blockquote>
<p>为了方便理解我将思路整理了一下，配合代码阅读更好</p>
<p>可能会有大量解释出现在代码块注释里</p>
</blockquote>
<h4 id="首先我们先要做一个很简单的验证，就是判断HTTP-REFERER是否存在，因为直接在浏览器地址栏上输入访问是不会带HTTP-REFERER的，那么什么情况下会有HTTP-REFERER存在，比较常用的就是a标签跳转（其他跳转方式不讲）"><a href="#首先我们先要做一个很简单的验证，就是判断HTTP-REFERER是否存在，因为直接在浏览器地址栏上输入访问是不会带HTTP-REFERER的，那么什么情况下会有HTTP-REFERER存在，比较常用的就是a标签跳转（其他跳转方式不讲）" class="headerlink" title="首先我们先要做一个很简单的验证，就是判断HTTP_REFERER是否存在，因为直接在浏览器地址栏上输入访问是不会带HTTP_REFERER的，那么什么情况下会有HTTP_REFERER存在，比较常用的就是a标签跳转（其他跳转方式不讲）"></a>首先我们先要做一个很简单的验证，就是判断HTTP_REFERER是否存在，因为直接在浏览器地址栏上输入访问是不会带HTTP_REFERER的，那么什么情况下会有HTTP_REFERER存在，比较常用的就是a标签跳转（其他跳转方式不讲）</h4><h5 id="判断HTTP-REFERER前需要了解的-1-1"><a href="#判断HTTP-REFERER前需要了解的-1-1" class="headerlink" title="判断HTTP_REFERER前需要了解的    1.1"></a>判断HTTP_REFERER前需要了解的    1.1</h5><p><img src="https://i.loli.net/2020/06/16/U49V7NJwvPEMijZ.png" alt="E_XO~G_NC6KP2`L@A4PB_D1.png"></p>
<h4 id="那么这个有什么弊端呢？我翻阅过网上不少资料，至少我没有看到有讲域名对HTTP-REFERER的影响的，那么这里我就讲一下顺便基于这张图再添加些东西方便理解"><a href="#那么这个有什么弊端呢？我翻阅过网上不少资料，至少我没有看到有讲域名对HTTP-REFERER的影响的，那么这里我就讲一下顺便基于这张图再添加些东西方便理解" class="headerlink" title="那么这个有什么弊端呢？我翻阅过网上不少资料，至少我没有看到有讲域名对HTTP_REFERER的影响的，那么这里我就讲一下顺便基于这张图再添加些东西方便理解"></a>那么这个有什么弊端呢？我翻阅过网上不少资料，至少我没有看到有讲域名对HTTP_REFERER的影响的，那么这里我就讲一下顺便基于这张图再添加些东西方便理解</h4><img src="https://i.loli.net/2020/06/16/kyoptVZiQ9HfU2w.png" alt="SOFAAAS_VFN2~Y@Y79__CLA.png">

<h4 id="如果你并不打算将你的资源服务器放在你的跳转源同域或子域的时候HTTP-REFERER验证便没法实现"><a href="#如果你并不打算将你的资源服务器放在你的跳转源同域或子域的时候HTTP-REFERER验证便没法实现" class="headerlink" title="如果你并不打算将你的资源服务器放在你的跳转源同域或子域的时候HTTP_REFERER验证便没法实现"></a>如果你并不打算将你的资源服务器放在你的跳转源同域或子域的时候HTTP_REFERER验证便没法实现</h4><h5 id="验证过程-1-2"><a href="#验证过程-1-2" class="headerlink" title="验证过程    1.2"></a>验证过程    1.2</h5><blockquote>
<p>所有代码都是一个文件，这里统一叫做 <code>check.php</code>方便后期做假设场景</p>
</blockquote>
<h4 id="我们先来看下面这段代码"><a href="#我们先来看下面这段代码" class="headerlink" title="我们先来看下面这段代码"></a>我们先来看下面这段代码</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$HTTP_REFERER = $_SERVER[<span class="string">'HTTP_REFERER'</span>];   <span class="comment">//获取请求信息</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($HTTP_REFERER)) &#123;		<span class="comment">//第一次判断是否存在HTTP_REFERER</span></span><br><span class="line">    <span class="keyword">if</span> (strstr($HTTP_REFERER,<span class="string">'mrhao'</span>)) &#123;	<span class="comment">//第二次判断HTTP_REFERER是否存在关键字符‘mrhao’</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'ok'</span>;		<span class="comment">//关键词就是你跳转前的链接关键词</span></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'no'</span>;</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span> &#123; </span><br><span class="line">    <span class="keyword">echo</span> (<span class="string">'NO'</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="那么最开始也最简单的HTTP-REFERER判断就搞定了"><a href="#那么最开始也最简单的HTTP-REFERER判断就搞定了" class="headerlink" title="那么最开始也最简单的HTTP_REFERER判断就搞定了"></a>那么最开始也最简单的HTTP_REFERER判断就搞定了</h4><h5 id="拟定链接失效思路-1-3"><a href="#拟定链接失效思路-1-3" class="headerlink" title="拟定链接失效思路    1.3"></a>拟定链接失效思路    1.3</h5><blockquote>
<p>下面内容可能会很多</p>
</blockquote>
<h4 id="首先让文件失效的办法我想到是改文件名字，那么就获取一些必要的参数，并还不急文件改名"><a href="#首先让文件失效的办法我想到是改文件名字，那么就获取一些必要的参数，并还不急文件改名" class="headerlink" title="首先让文件失效的办法我想到是改文件名字，那么就获取一些必要的参数，并还不急文件改名"></a>首先让文件失效的办法我想到是改文件名字，那么就获取一些必要的参数，并还不急文件改名</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">   $time = time(); <span class="comment">//获取时间戳</span></span><br><span class="line"><span class="comment">//很简单的获取时间戳函数</span></span><br><span class="line">   @$getfile = $_GET[file];    <span class="comment">//获取参数file</span></span><br><span class="line"><span class="comment">//接收来着GET的请求里的file参数（这个参数其实就是文件全名的base64密文）</span></span><br><span class="line">   @$base64de = base64_decode($getfile);   <span class="comment">//解密file参数</span></span><br><span class="line"></span><br><span class="line">   @$dname = md5(<span class="string">"$base64de.$getdlfile.$time"</span>);    <span class="comment">//拼接解密的文件名+参数file+现在时间戳，并MD5加密留用</span></span><br><span class="line"><span class="comment">//这里我们将解出来的文件名(原名)+提交过来的密文+时间戳，然后MD5加密后得到一个32位的密文</span></span><br><span class="line">   $data = <span class="keyword">array</span>(<span class="string">'time'</span> =&gt; <span class="string">"$time"</span>,<span class="string">'yname'</span> =&gt; <span class="string">"$base64de"</span>,<span class="string">'dname'</span> =&gt; <span class="string">"$dname"</span>);    <span class="comment">//更新数组数据留用</span></span><br><span class="line"><span class="comment">//为了到时候方便储存我们整个数组出来，数组的参数有time(写入时间)，yname(源名)，dname(更新的名)</span></span><br><span class="line"><span class="comment">//这个dname其实就是加密后的MD5密文</span></span><br><span class="line">   $datajson =  json_encode($data);    <span class="comment">//格式化数组数据为json</span></span><br><span class="line"><span class="comment">//将数组json格式化下次方便读取</span></span><br></pre></td></tr></table></figure>

<h4 id="拿到数据后可以开始处理了，现在我们看下方这个场景介绍"><a href="#拿到数据后可以开始处理了，现在我们看下方这个场景介绍" class="headerlink" title="拿到数据后可以开始处理了，现在我们看下方这个场景介绍"></a>拿到数据后可以开始处理了，现在我们看下方这个场景介绍</h4><blockquote>
<p>有一个叫<code>www.zip</code>的文件刚刚放进目录</p>
<p>然后我提交一个请求    <code>http://xxx.xxx/check.php?file=d3d3LnppcA==</code></p>
<p>这里我们提交的数据是    <code>file=d3d3LnppcA==</code></p>
</blockquote>
<h4 id="好，那么接下来我们拿到一个密文d3d3LnppcA-解析出来是www-zip那么我们获取新文件名，我们的文件名计算公式是MD5加密源文件名-收到的base64密文-时间戳"><a href="#好，那么接下来我们拿到一个密文d3d3LnppcA-解析出来是www-zip那么我们获取新文件名，我们的文件名计算公式是MD5加密源文件名-收到的base64密文-时间戳" class="headerlink" title="好，那么接下来我们拿到一个密文d3d3LnppcA==解析出来是www.zip那么我们获取新文件名，我们的文件名计算公式是MD5加密源文件名+收到的base64密文+时间戳"></a>好，那么接下来我们拿到一个密文<code>d3d3LnppcA==</code>解析出来是<code>www.zip</code>那么我们获取新文件名，我们的文件名计算公式是MD5加密<code>源文件名+收到的base64密文+时间戳</code></h4><h4 id="我们要将处理好的json数据储存到一个文件里，看下面的代码"><a href="#我们要将处理好的json数据储存到一个文件里，看下面的代码" class="headerlink" title="我们要将处理好的json数据储存到一个文件里，看下面的代码"></a>我们要将处理好的json数据储存到一个文件里，看下面的代码</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">   $filecz = file_exists(<span class="string">"./$base64de"</span>);   <span class="comment">//file_exists函数判断请求文件是否存在</span></span><br><span class="line"><span class="keyword">if</span> ($filecz==<span class="keyword">true</span>) &#123;    <span class="comment">//首次上传文件修改</span></span><br><span class="line">       $fileput = file_put_contents (<span class="string">"./ZmlsZA/$base64de"</span>.<span class="string">'.php'</span>, <span class="string">"$datajson"</span>); <span class="comment">//写入数组到文件</span></span><br><span class="line">       <span class="comment">//这个写入函数的需要文件名和写入内容两个参数，这里我需要讲一下文件名参数</span></span><br><span class="line">       <span class="comment">//文件名后缀我用`.php`因为这样就无法被下载，但是要是有人直接打开看呢</span></span><br><span class="line">       <span class="comment">//还是有办法的首先你需要新建一个文件夹这个文件夹是乱码最好</span></span><br><span class="line">       <span class="comment">//这里我的路径是`./ZmlsZA/`这里只存放php后缀的json数据文件</span></span><br><span class="line">       $oldname = <span class="string">"/volume1/web/download/$base64de"</span>;   <span class="comment">//旧名字（首次上传名）</span></span><br><span class="line">       $newname = <span class="string">"/volume1/web/download/$dname"</span>;  <span class="comment">//新名字（自动根据时间戳生成）</span></span><br><span class="line">       <span class="comment">//这里是文件路径，你可以选择直接新建一个文件夹或者直接在主目录</span></span><br><span class="line">       rename($oldname,$newname);    <span class="comment">//修改名字</span></span><br><span class="line">       <span class="comment">//然后修改名字完成新文件第一次改名</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里需要对<code>rename</code>函数再多讲几句</p>
<p>Windows下使用rename函数可能没有太大问题相对路径也是可用的</p>
<p>而linux下就有些差别，相对路径我是无法使用的（群晖NAS），以外还有linux的文件权限问题，http用户组权限要有写入权限（写入json数据用）还有删除权限（改名大概算是删除上一个文件），网站目录的权限最好0770</p>
</blockquote>
<h5 id="读取数据-1-3-1"><a href="#读取数据-1-3-1" class="headerlink" title="读取数据    1.3.1"></a>读取数据    1.3.1</h5><h4 id="废话不多说直接上代码"><a href="#废话不多说直接上代码" class="headerlink" title="废话不多说直接上代码"></a>废话不多说直接上代码</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$fileget = file_get_contents (<span class="string">"./ZmlsZA/$base64de"</span>.<span class="string">'.php'</span>);  <span class="comment">//读取现存数据</span></span><br><span class="line"><span class="comment">//读取数据--每个文件都有自己的独立数据不会混淆</span></span><br><span class="line">   $datajsonde = json_decode($fileget);    <span class="comment">//解json现存数据</span></span><br><span class="line"><span class="comment">//解析json为数组</span></span><br><span class="line">   $filetime = $datajsonde-&gt;&#123;<span class="string">'time'</span>&#125;; <span class="comment">//提取现存数据时间戳</span></span><br><span class="line"></span><br><span class="line">   $filename = $datajsonde-&gt;&#123;<span class="string">'dname'</span>&#125;; <span class="comment">//提取现存文件识标</span></span><br><span class="line"></span><br><span class="line">   $timeadd = $filetime + <span class="number">20</span>;   <span class="comment">//设置过期时间</span></span><br><span class="line"><span class="comment">//过期时间就是文件时间+设置的过期时效得到过期时间戳</span></span><br><span class="line">   <span class="keyword">if</span> ($filetime == <span class="keyword">null</span>) &#123;    <span class="comment">//如果获取不到现存数据直接停止</span></span><br><span class="line">       <span class="keyword">echo</span> <span class="string">'验证下载失败，请联系管理员'</span>;</span><br><span class="line">       <span class="keyword">exit</span>();</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">//这里是为了防止写入错误等一系列突发情况写的</span></span><br><span class="line">   <span class="keyword">if</span> ($timeadd &lt; $time) &#123;</span><br><span class="line">       <span class="comment">//这里是下载处理下面讲</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h4 id="文件过期处理改名处理已经搞定，接下来是文件下载处理"><a href="#文件过期处理改名处理已经搞定，接下来是文件下载处理" class="headerlink" title="文件过期处理改名处理已经搞定，接下来是文件下载处理"></a>文件过期处理改名处理已经搞定，接下来是文件下载处理</h4><h5 id="文件下载处理-1-4"><a href="#文件下载处理-1-4" class="headerlink" title="文件下载处理    1.4"></a>文件下载处理    1.4</h5><h4 id="直接上代码"><a href="#直接上代码" class="headerlink" title="直接上代码"></a>直接上代码</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ($timeadd &lt; $time) &#123;     <span class="comment">//如果过期就将上方的数组写入</span></span><br><span class="line">    <span class="comment">//对比过期时间戳和现在时间</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'获取链接中'</span>;</span><br><span class="line">        $oldname = <span class="string">"/volume1/web/owncloud/$filename"</span>; <span class="comment">//旧名字（现存数据读取）</span></span><br><span class="line">        $newname = <span class="string">"/volume1/web/owncloud/$dname.zip"</span>;  <span class="comment">//新名字（自动根据时间戳生成）</span></span><br><span class="line">        rename($oldname,$newname);   <span class="comment">//重新命名文件以更新链接</span></span><br><span class="line">        $fileput = file_put_contents (<span class="string">"./ZmlsZA/$base64de"</span>.<span class="string">'.php'</span>, <span class="string">"$datajson"</span>);     <span class="comment">//写入数据以便下次读取</span></span><br><span class="line">    	<span class="comment">//过期直接更新链接并保存数据进文件</span></span><br><span class="line">        <span class="comment">//自动刷新以不动声色下载</span></span><br><span class="line">        <span class="comment">//本来采用header("Refresh:0");</span></span><br><span class="line">		<span class="comment">//但是由于有时候不知道为什么没反应，所以直接换成js的跳转，插入js代码</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'...'</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;script&gt;'</span>; </span><br><span class="line">		<span class="keyword">echo</span> <span class="string">"window.location.href='check.php?file=$getfile'"</span>;</span><br><span class="line">    	<span class="comment">//js重新发送请求刷新界面，这并不会丢失HTTP_REFERER，刷新后就是在文件时限内了，就直接跳到下面的代码了</span></span><br><span class="line">		<span class="keyword">echo</span> <span class="string">'&lt;/script&gt;'</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'可下载'</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;script&gt;"</span>; </span><br><span class="line">		<span class="keyword">echo</span> <span class="string">"window.location.href='$filename'"</span>; </span><br><span class="line">    	<span class="comment">//同样跳转到读取数据里保存的文件名</span></span><br><span class="line">		<span class="keyword">echo</span> <span class="string">"&lt;/script&gt;"</span>;</span><br><span class="line">        <span class="comment">//header("Location: $dname.zip");  //若在时限内则可直接访问下载</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="那么这就是所有内容了"><a href="#那么这就是所有内容了" class="headerlink" title="那么这就是所有内容了"></a>那么这就是所有内容了</h4><hr>
<h5 id="后言"><a href="#后言" class="headerlink" title="后言"></a>后言</h5><p>其实这是个很简单的写法，而且验证的方式也很简单，并没有其他一站式应用这么完整的验证机制（如session和cookie这些判断包括一些专门的交付相应代币来下载）</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2020-06-15</span><i class="fa fa-tag"></i><a class="tag" href="/blog/tags/PHP/" title="PHP">PHP </a><a class="tag" href="/blog/tags/hexo/" title="hexo">hexo </a><a class="tag" href="/blog/tags/实用/" title="实用">实用 </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,https://git.mrhao.xyz/blog/2020/06/15/php防盗链时效下载/,Mrhao Blog,PHP写个资源失效下载防盗链,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/blog/2021/05/24/Bilibili抽奖脚本/" title="Bilibili抽奖启动脚本">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/blog/2020/06/15/php防盗链时限下载/" title="PHP写个资源失效下载防盗链">下一篇</a></li></ul></div><div style="margin:0 30px;/* background-color: #cfcfcf6b; *//* box-shadow: 0px 0px 0px 0px black; *//* text-shadow: 0px 0px 0px #210000; *//* background-color: white; *//* text-shadow: 0 0 #00000038; */color: #000000ad;"><blockquote style="background-color: #c5c5c5;"><div class="vwrap"><div class="post-copyright-author"><span class="post-copyright-meta">本文作者: </span><span class="post-copyright-info"><a href="https://github.com/JHPatchouli" style="word-wrap:break-word;color: #3668b3c4;">Mrhao</a></span></div><div class="post-copyright-type"><span class="post-copyright-meta">本文链接: </span><span class="post-copyright-info"><a href="https://git.mrhao.xyz/blog/2020/06/15/php防盗链时效下载/" style="word-wrap:break-word;color: #3668b3c4;">https://git.mrhao.xyz/blog/2020/06/15/php防盗链时效下载/</a></span></div><div class="post-copyright-notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info"><br>本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" style="word-wrap:break-word;color: #3668b3c4;"> CC BY-NC-SA 4.0 </a>许可协议。转载请注明来自<a href="https://git.mrhao.xyz/blog" style="word-wrap:break-word;color: #3668b3c4;">Mrhao Blog</a></span></div></div></blockquote></div><a id="comments"></a><div id="vcomments" style="margin:0 30px;"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/gh/xcss/valine@v1.1.7/dist/Valine.min.js?v=undefined"></script><script>var valine = new Valine({
  el:'#vcomments',
  notify:false || false, 
  verify:true|| false, 
  app_id:'TlHtUet16iamRMk84dIJIGOg-gzGzoHsz',
  app_key:'3o7SE7LdAoTXJlrPx6gURmRx',
  placeholder:'说点什么吧。。',
  path: window.location.pathname,
  avatar:'hide'
})</script></div></div></div></div><script src="/blog/js/jquery.js"></script><script src="/blog/js/jquery-migrate-1.2.1.min.js"></script><script src="/blog/js/jquery.appear.js"></script></body></html>